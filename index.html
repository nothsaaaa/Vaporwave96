<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raytracer Demo</title>
    <style>
        body, html {
            margin: 0;
            overflow: hidden;
            background: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
            font-family: Arial, sans-serif;
        }
       
        #container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
       
        canvas {
            image-rendering: pixelated;
            width: 512px;
            height: 512px;
            background: #000;
            cursor: crosshair;
        }
       
        #controls {
            color: #ccc;
            margin-top: 10px;
            text-align: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        <div id="controls">
          <p>WASD</p>
          <p>Shift & Space</p>
        </div>
    </div>
    
    <script src="engine.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const engine = new RaytracingEngine(canvas, 128, 1000);
        
        const sphereId = engine.createObject(
            0, 0, 0,
            100,
            'sphere',
            {x:0, y:0, z:0},
            {r:255, g:100, b:100},
            0.4
        );
        
        const planeId = engine.createObject(
            0, -100, 0,
            0,
            'plane',
            {x:0, y:0, z:0},
            {r:200, g:200, b:255}
        );
        
        const cubeId = engine.createObject(
            200, 0, 0,
            50,
            'cube',
            {x:0, y:0, z:0},
            {r:100, g:255, b:100}
        );
        
        const sphere2Id = engine.createObject(
            -150, 50, 100,
            60,
            'sphere',
            {x:0, y:0, z:0},
            {r:255, g:255, b:100}
        );
        
        const cube2Id = engine.createObject(
            0, 50, 200,
            40,
            'cube',
            {x:0.5, y:0, z:0},
            {r:255, g:100, b:255}
        );
        
        const keys = {};
        let mouseDown = false;
        const speed = 400;
        const sensitivity = 0.002;
        
        window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
        
        canvas.addEventListener('mousedown', e => {
            mouseDown = true;
            canvas.requestPointerLock();
        });
        
        document.addEventListener('mouseup', e => {
            mouseDown = false;
            document.exitPointerLock();
        });
        
        document.addEventListener('pointerlockchange', () => {
            if (document.pointerLockElement !== canvas) mouseDown = false;
        });
        
        document.addEventListener('mousemove', e => {
            if (!mouseDown) return;
            const rot = engine.getRotation();
            rot.yaw -= e.movementX * sensitivity;
            rot.pitch -= e.movementY * sensitivity;
            rot.pitch = Math.max(-Math.PI/2 + 0.01, Math.min(Math.PI/2 - 0.01, rot.pitch));
            engine.setRotation(rot.yaw, rot.pitch);
        });
        
        function updatePlayer(dt) {
            const cam = engine.getCamera();
            const rot = engine.getRotation();
            
            const forward = {
                x: Math.cos(rot.pitch) * Math.sin(rot.yaw),
                y: Math.sin(rot.pitch),
                z: Math.cos(rot.pitch) * Math.cos(rot.yaw)
            };
            
            const up = {x: 0, y: 1, z: 0};
            const right = {
                x: forward.y * up.z - forward.z * up.y,
                y: forward.z * up.x - forward.x * up.z,
                z: forward.x * up.y - forward.y * up.x
            };
            
            const rightLen = Math.sqrt(right.x * right.x + right.y * right.y + right.z * right.z);
            if (rightLen > 0) {
                right.x /= rightLen;
                right.y /= rightLen;
                right.z /= rightLen;
            }
            
            if (keys['w']) {
                cam.x += forward.x * speed * dt;
                cam.y += forward.y * speed * dt;
                cam.z += forward.z * speed * dt;
            }
            if (keys['s']) {
                cam.x -= forward.x * speed * dt;
                cam.y -= forward.y * speed * dt;
                cam.z -= forward.z * speed * dt;
            }
            if (keys['a']) {
                cam.x -= right.x * speed * dt;
                cam.y -= right.y * speed * dt;
                cam.z -= right.z * speed * dt;
            }
            if (keys['d']) {
                cam.x += right.x * speed * dt;
                cam.y += right.y * speed * dt;
                cam.z += right.z * speed * dt;
            }
            if (keys[' ']) cam.y += speed * dt;
            if (keys['shift']) cam.y -= speed * dt;
            
            engine.setCamera(cam.x, cam.y, cam.z);
        }
        
        let lastTime = 0;
        let angle = 0;
        let time = 0;
        
        function animate(currentTime) {
            const dt = (currentTime - lastTime) / 1000;
            lastTime = currentTime;
            
            updatePlayer(dt);
            
            angle += 0.7 * dt;
            engine.updateObject(cubeId, {
                rotation: {x: angle * 0.7, y: angle, z: angle * 0.5}
            });
            
            time += 1.0 * dt;
            const radius = 400;
            const x = Math.cos(time) * radius - 50;
            const z = Math.sin(time) * radius + 50;
            engine.updateObject(sphere2Id, {
                position: engine.v3(x, 50 + Math.sin(time * 1) * 20, z)
            });
            
            requestAnimationFrame(animate);
        }

        
        engine.start();
        requestAnimationFrame(animate);
    </script>
</body>
</html>